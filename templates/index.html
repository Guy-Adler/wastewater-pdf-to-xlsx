<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF to XLSX Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #333;
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .upload-form {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .file-input-group {
      position: relative;
    }

    .file-input-group label {
      display: block;
      margin-bottom: 10px;
      color: #333;
      font-weight: 500;
      font-size: 1.1em;
    }

    .file-input {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-input input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: block;
      padding: 15px 20px;
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #6c757d;
      font-size: 1em;
    }

    .file-input-label:hover {
      background: #e9ecef;
      border-color: #adb5bd;
      color: #495057;
    }

    .file-input input[type=file]:focus+.file-input-label {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .selected-file {
      margin-top: 10px;
      padding: 10px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 5px;
      color: #155724;
      font-size: 0.9em;
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .submit-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .flash-messages {
      margin-bottom: 20px;
    }

    .flash-message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .flash-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .flash-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }

      .header h1 {
        font-size: 2em;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>PDF to XLSX Converter</h1>
      <p>Upload your PDF and XLSX files to transform and download the processed output</p>
    </div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-messages">
      {% for message in messages %}
      <div class="flash-message error">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form class="upload-form" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data"
      id="uploadForm">
      <div class="file-input-group" id="pdf-group">
        <label for="pdf_file">PDF File:</label>
        <div class="file-input">
          <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required>
          <label for="pdf_file" class="file-input-label">
            ðŸ“„ Choose PDF file or drag and drop here
          </label>
        </div>
        <div id="pdf-selected" class="selected-file" style="display: none;"></div>
      </div>

      <div class="file-input-group" id="xlsx-group">
        <label for="xlsx_file">XLSX/XLS File:</label>
        <div class="file-input">
          <input type="file" id="xlsx_file" name="xlsx_file" accept=".xlsx,.xls" required>
          <label for="xlsx_file" class="file-input-label">
            ðŸ“Š Choose XLSX/XLS file or drag and drop here
          </label>
        </div>
        <div id="xlsx-selected" class="selected-file" style="display: none;"></div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        ðŸš€ Process Files
      </button>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Processing your files... Please wait.</p>
    </div>
  </div>

  <script>
    // File selection display
    function updateFileDisplay(input, displayElement) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        displayElement.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        displayElement.style.display = 'block';
      } else {
        displayElement.style.display = 'none';
      }
    }

    // PDF file selection
    document.getElementById('pdf_file').addEventListener('change', function () {
      updateFileDisplay(this, document.getElementById('pdf-selected'));
    });

    // XLSX file selection
    document.getElementById('xlsx_file').addEventListener('change', function () {
      updateFileDisplay(this, document.getElementById('xlsx-selected'));
    });

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent default form submission

      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const formData = new FormData(this);

      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      loading.style.display = 'block';

      fetch('/upload', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Get the filename from the response headers
          const contentDisposition = response.headers.get('content-disposition');
          let filename = 'processed_file.xlsx';

          console.log('Content-Disposition header:', contentDisposition);

          // First, try to use the original XLSX filename
          const xlsxFile = document.getElementById('xlsx_file').files[0];
          if (xlsxFile) {
            filename = xlsxFile.name;
            console.log('Using original filename:', filename);
          }

          // If we have a content-disposition header, try to extract filename from it
          if (contentDisposition) {
            // Try different patterns for filename extraction
            let filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
            if (!filenameMatch) {
              filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
            }
            if (!filenameMatch) {
              filenameMatch = contentDisposition.match(/filename=([^;]+)/);
            }

            if (filenameMatch) {
              const extractedFilename = decodeURIComponent(filenameMatch[1]);
              console.log('Extracted filename from header:', extractedFilename);
              // Only use header filename if it's different from the original and not empty
              if (extractedFilename && extractedFilename.trim() && extractedFilename !== filename) {
                filename = extractedFilename;
              }
            }
          }

          return response.blob().then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Reset UI after successful download
            submitBtn.disabled = false;
            submitBtn.textContent = 'ðŸš€ Process Files';
            loading.style.display = 'none';
          });
        })
        .catch(error => {
          console.error('Error:', error);
          // Reset UI on error
          submitBtn.disabled = false;
          submitBtn.textContent = 'ðŸš€ Process Files';
          loading.style.display = 'none';

          // Show error message
          const flashMessages = document.querySelector('.flash-messages') ||
            document.createElement('div');
          if (!document.querySelector('.flash-messages')) {
            flashMessages.className = 'flash-messages';
            document.querySelector('.container').insertBefore(
              flashMessages,
              document.querySelector('.upload-form')
            );
          }

          const errorDiv = document.createElement('div');
          errorDiv.className = 'flash-message error';
          errorDiv.textContent = 'Error processing files. Please try again.';
          flashMessages.appendChild(errorDiv);

          // Remove error message after 5 seconds
          setTimeout(() => {
            if (errorDiv.parentNode) {
              errorDiv.parentNode.removeChild(errorDiv);
            }
          }, 5000);
        });
    });

    // Drag and drop functionality
    function setupDragAndDrop(inputId, containerSelector) {
      const input = document.getElementById(inputId);
      const container = document.querySelector(containerSelector);
      const label = container.querySelector('.file-input-label');

      container.addEventListener('dragover', function (e) {
        e.preventDefault();
        label.style.background = '#e9ecef';
        label.style.borderColor = '#adb5bd';
      });

      container.addEventListener('dragleave', function (e) {
        e.preventDefault();
        // Only reset if we're leaving the container entirely
        if (!this.contains(e.relatedTarget)) {
          label.style.background = '#f8f9fa';
          label.style.borderColor = '#dee2e6';
        }
      });

      container.addEventListener('drop', function (e) {
        e.preventDefault();
        label.style.background = '#f8f9fa';
        label.style.borderColor = '#dee2e6';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          input.dispatchEvent(new Event('change'));
        }
      });
    }

    setupDragAndDrop('pdf_file', '#pdf-group');
    setupDragAndDrop('xlsx_file', '#xlsx-group');
  </script>
</body>

</html>